#Growatt Local using grott as MQTT
#https://github.com/johanmeijer/grott/wiki

# Grott - Home Assistant Growatt sensors 
# 
# This file exposes all sensors from Grott to HA, including dummy sensors for the type of the inverter and the type and serial number of the datalogger (Be aware, the dummy
# sensors have to be set manually) 

- platform: template
  sensors:
    growatt_inverter:
      unique_id: growatt_invertertype
      friendly_name: Growatt - Type
      # Please set the type of your inverter
      value_template: "SPF 3000TL-LVM"
      icon_template: mdi:select-inverse

- platform: template
  sensors:
    growatt_datalogger_type:
      unique_id: growatt_datloggertype
      friendly_name: Growatt - Datalogger type
      # Please set the type of your datalogger
      value_template: "ShineWifi S"
      icon_template: mdi:select-inverse

- platform: template
  sensors:
    growatt_datalogger_serial:
      unique_id: growatt_datlogger_serial
      friendly_name: Growatt - Datalogger serienr
      # Please set the serial number of your datalogger
      value_template: "	DDD0A2914J"
      icon_template: mdi:select-inverse

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['device'] }}" 
  unique_id: growatt_serial
  name: Growatt - Serial number
  icon: mdi:select-inverse

- platform: mqtt
  state_topic: GROWATT
  # If you like to have the date in another format, please change "timestamp_custom('%d-%m-%Y')"
  # For more information: https://docs.python.org/3/library/time.html#time.strftime
  value_template: "{{ as_timestamp(strptime(value_json['time'], '%Y-%m-%dT%H:%M:%S')) | timestamp_custom('%d-%m-%Y') }}" 
  unique_id: growatt_date
  name: Growatt - Date
  icon: mdi:calendar

- platform: mqtt
  state_topic: GROWATT
  # If you like to have the date in another format, please change "timestamp_custom('%H:%M:%S')"
  # For more information: https://docs.python.org/3/library/time.html#time.strftime
  value_template: "{{ as_timestamp(strptime(value_json['time'], '%Y-%m-%dT%H:%M:%S')) | timestamp_custom('%H:%M:%S') }}" 
  unique_id: growatt_time
  name: Growatt - Time
  icon: mdi:clock-digital

- platform: mqtt
  state_topic: GROWATT
  value_template: >
    {% if (value_json['values']['pvstatus'] | int == 0) %}
      Combine-Charge_and_Bypass	
    {% elif (value_json['values']['pvstatus'] | int == 1) %}
      MPPT-Charge_and_Discharge	
    {% elif (value_json['values']['pvstatus'] | int == 2) %}
      Discharge
    {% elif (value_json['values']['pvstatus'] | int == 10) %}
      AC-Charge_and_Bypass
    {% elif (value_json['values']['pvstatus'] | int == 11) %}
      Bypass
    {% else %}
      Unknown
    {% endif %}
  unique_id: growatt_status
  name: Growatt - State
  icon: mdi:power-settings

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['pvpowerout'] | int / 10 }}" 
  unique_id: growatt_actual_output_power
  device_class: power
  unit_of_measurement: "W"
  name: Growatt - Output watt (Actual)

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['op_va'] | int / 10 }}" 
  unique_id: growatt_actual_output_va
  device_class: power
  unit_of_measurement: "VA"
  name: Growatt - Output VA (Actual)

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['bat_Volt'] | int / 100 }}" 
  unique_id: growatt_actual_battery_voltage
  device_class: power
  unit_of_measurement: "V"
  name: Growatt - Battery Voltage (Actual)

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['grid_volt'] | int / 10 }}" 
  unique_id: growatt_grid_voltage
  device_class: voltage
  unit_of_measurement: "V"
  name: Growatt - Grid voltage

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['line_freq'] | int / 100 }}" 
  unique_id: growatt_grid_frequency
  unit_of_measurement: "Hz"
  name: Growatt - Grid frequency
  icon: mdi:waveform

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['outputvolt'] | int / 10 }}" 
  unique_id: growatt_output_voltage
  device_class: voltage
  unit_of_measurement: "V"
  name: Growatt - Output voltage

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['outputfreq'] | int / 100 }}" 
  unique_id: growatt_inverter_output_frequency
  unit_of_measurement: "Hz"
  name: Growatt - Output frequency
  icon: mdi:waveform

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['invtemp'] | int / 10 }}" 
  unique_id: growatt_inverer_temperature
  device_class: temperature
  unit_of_measurement: "°C"
  name: Growatt - Inverter temperature

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['dcdctemp'] | int / 10 }}" 
  unique_id: growatt_inverer_dcdctemp_temperature
  device_class: temperature
  unit_of_measurement: "°C"
  name: Growatt - dcdctemp temperature

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['loadpercent'] | int / 10 }}" 
  name: "Inverter Load Percent"
  unit_of_measurement: "%"
  unique_id: "growatt_inverer_load_percent"
  device_class: power
  icon: mdi:home-lightning-bolt

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['pvenergytoday'] | int / 10 }}" 
  unique_id: growatt_generated_energy_today
  device_class: energy
  unit_of_measurement: "kWh"
  name: Growatt - Generated energy (Today)
  icon: mdi:solar-panel-large

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['epvtotal'] | int / 10 }}" 
  unique_id: growatt_generated_energy_total
  device_class: energy
  unit_of_measurement: "kWh"
  name: Growatt - Generated energy (Total)
  icon: mdi:solar-panel-large

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['eacCharToday'] | int }}" 
  unique_id: growatt_ac_charged_today
  device_class: energy
  unit_of_measurement: "kWh"
  name: Growatt - AC Charged (Today)
  icon: mdi:transmission-tower-export

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['eacCharTotal'] | int }}" 
  unique_id: growatt_ac_charged_total
  device_class: energy
  unit_of_measurement: "kWh"
  name: Growatt - AC Charged (Total)
  icon: mdi:transmission-tower-export

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['ebatDischarToday'] | int / 10 }}" 
  unique_id: growatt_bat_discharged_today
  device_class: energy
  unit_of_measurement: "kWh"
  name: Growatt - Battery Discharged (Today)
  icon: mdi:home-battery

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['ebatDischarTotal'] | int / 10 }}" 
  unique_id: growatt_bat_discharged_total
  device_class: energy
  unit_of_measurement: "kWh"
  name: Growatt - Battery Discharged (Total)
  icon: mdi:home-battery

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['eacDischarToday'] | int }}" 
  unique_id: growatt_ac_discharged_today
  device_class: energy
  unit_of_measurement: "kWh"
  name: Growatt - AC Discharged (Today)
  icon: mdi:transmission-tower-export

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['eacDischarTotal'] | int }}" 
  unique_id: growatt_ac_discharged_total
  device_class: energy
  unit_of_measurement: "kWh"
  name: Growatt - AC Discharged (Total)
  icon: mdi:transmission-tower-export

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['ACCharCurr'] | int / 10 }}" 
  unique_id: growatt_ac_to_battery_current
  device_class: current
  unit_of_measurement: "A"
  name: Growatt - AC Charging (Current)
  icon: mdi:current-dc

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['ACDischarWatt'] | int / 10 }}" 
  unique_id: growatt_actual_ac_discharge_watt
  device_class: power
  unit_of_measurement: "W"
  name: Growatt - AC Output watt (Actual)

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['ACDischarVA'] | int / 10 }}" 
  unique_id: growatt_actual_ac_discharge_va
  device_class: power
  unit_of_measurement: "VA"
  name: Growatt - AC Output VA (Actual)

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['BatDischarWatt'] | int / 10 }}" 
  unique_id: growatt_actual_battery_discharge_watt
  device_class: power
  unit_of_measurement: "W"
  name: Growatt - AC Output watt (Actual)

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['BatDischarVA'] | int / 10 }}" 
  unique_id: growatt_actual_battery_discharge_va
  device_class: power
  unit_of_measurement: "VA"
  name: Growatt - AC Output VA (Actual)




- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['pv1watt'] | int / 10 }}" 
  unique_id: growatt_string1_watt
  device_class: power
  unit_of_measurement: "W"
  name: Growatt - String 1 (Watt)

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['pv1voltage'] | int / 10 }}" 
  unique_id: growatt_string1_voltage
  device_class: voltage
  unit_of_measurement: "V"
  name: Growatt - String 1 (Voltage)

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['pv1current'] | int / 10 }}" 
  unique_id: growatt_string1_current
  device_class: current
  unit_of_measurement: "A"
  name: Growatt - String 1 (Current)
  icon: mdi:current-dc

- platform: mqtt
  state_topic: GROWATT
  value_template: "{{ value_json['values']['pvpowerin'] | int / 10 }}" 
  unique_id: growatt_actual_input_power
  device_class: power
  unit_of_measurement: "W"
  name: Growatt - Grid Input watt (Actual)  
